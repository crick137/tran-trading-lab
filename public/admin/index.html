<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console Â· TRAN TRADING LAB</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <style>
    :root{ --bg:#0f1115; --card:#15171a; --fg:#eaecee; --muted:#9aa0a6; --bd:#23262b; --primary:#3b82f6; }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
    .container{max-width:1040px; margin:24px auto; padding:0 16px}
    .card{ background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); color:var(--fg); }
    .muted{ color:var(--muted); }
    input,select,textarea{ background:#0f1115; border:1px solid var(--bd); color:#fff; padding:8px 10px; border-radius:10px; outline:none; }
    input:focus,select:focus,textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.2); }
    .icon-btn{ background:transparent; border:1px solid #2a2f36; color:var(--fg); padding:6px 10px; border-radius:8px; cursor:pointer }
    .icon-btn:hover{ background:#1b1f24 }
    button.primary{ padding:10px 14px; border-radius:12px; border:0; background:var(--primary); color:#fff; font-weight:700; cursor:pointer }
    button.primary:hover{ filter:brightness(1.05) }
    .tab-btn{ border:1px solid var(--bd); background:#121418; color:var(--fg); padding:10px 14px; border-radius:10px; cursor:pointer }
    .tab-btn.active{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2) }
    .tab{ display:none } .tab.active{ display:block }
    textarea{ min-height: 120px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .hint{ font-size:12px; opacity:.75 }
    .split{ display:grid; gap:12px; grid-template-columns: 1.2fr .8fr; } @media (max-width: 900px){ .split { grid-template-columns: 1fr } }
    .kbd{ border:1px solid #2a2f36; background:#1b1f24; padding:2px 6px; border-radius:6px; font-size:12px }
    .danger{ color:#f87171; border-color:#f87171 }

    /* ç™»å½•é®ç½© */
    #pw-overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(4px); z-index:9999;
    }
    .login-box{
      width:min(92vw,420px); background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.5)
    }
    .login-box h3{ margin:4px 0 10px }
    .login-box .row{ margin-top:8px }
  </style>
</head>
<body>

  <!-- ç™»å½•é®ç½©ï¼šæœªç™»å½•æ—¶æ˜¾ç¤º -->
  <div id="pw-overlay" style="display:none">
    <div class="login-box">
      <h3>ç®¡ç†å‘˜ç™»å½•</h3>
      <p class="muted" style="margin:0 0 6px">è¿›å…¥åå°å‰éœ€è¾“å…¥ä¸€æ¬¡å£ä»¤ï¼›è¿›å…¥åå‘å¸ƒæ— éœ€å†å¡«ã€‚</p>
      <div class="row">
        <input id="admin-pw" type="password" placeholder="ADMIN_PASSWORD" style="flex:1" />
        <button id="pw-enter" class="primary">è¿›å…¥åå°</button>
      </div>
      <p id="pw-err" class="muted" style="color:#f87171; min-height:18px; margin:8px 0 0"></p>
    </div>
  </div>

  <!-- åå°ä¸»ä½“ï¼šç™»å½•åæ˜¾ç¤º -->
  <div id="admin-root" style="display:none">
    <main class="admin container">
      <section class="card" style="padding:16px">
        <h2 style="margin:0 0 10px">Admin Console</h2>

        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="logout-admin" class="icon-btn">é€€å‡ºç™»å½•</button>
          </div>
          <div class="row" style="align-items:center; gap:10px">
            <div class="muted">è‰ç¨¿è‡ªåŠ¨ä¿å­˜ Â· <span class="kbd">Ctrl/Cmd + Enter</span> å‘å¸ƒ</div>
            <button id="clear-drafts" class="icon-btn danger">æ¸…ç©ºæœ¬åœ°è‰ç¨¿</button>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <button class="tab-btn active" data-tab="brief">Daily Brief</button>
          <button class="tab-btn" data-tab="analyses">Analyses</button>
          <button class="tab-btn" data-tab="news">Market News</button>
          <button class="tab-btn" data-tab="research">Research</button>
          <button class="tab-btn" data-tab="r-articles">Articles</button>
        </div>

        <!-- Daily Brief -->
        <div class="tab active" id="tab-brief">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œä¸å¡«=ä»Šå¤©ï¼‰<input id="b-slug" placeholder="2025-10-18" /></label>
                <label class="full">æ ‡é¢˜<input id="b-title" placeholder="Daily Brief æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" /></label>
                <label class="full">æ ¸å¿ƒè¦ç‚¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="b-bullets"></textarea></label>
                <label class="full">ä»Šæ—¥æ—¥ç¨‹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="b-schedule"></textarea></label>
                <label>å›¾è¡¨ç¬¦å·<input id="b-symbol" placeholder="FX:XAUUSD" /></label>
                <label>å›¾è¡¨å‘¨æœŸ
                  <select id="b-interval">
                    <option value="15">15m</option>
                    <option value="60" selected>1H</option>
                    <option value="240">4H</option>
                    <option value="1D">1D</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="b-publish" class="primary">å‘å¸ƒ</button>
                <button id="b-reuse" class="icon-btn">æ˜¨æ—¥å¤ç”¨</button>
                <button id="b-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="b-delete" class="icon-btn danger">åˆ é™¤è¯¥æ—¥æœŸ</button>
                <button id="b-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="b-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>å‘å¸ƒåˆ° <code>/api/daily-brief/YYYY-MM-DD.json</code>ï¼ˆè‡ªåŠ¨é™„å¸¦ Authorizationï¼‰</li>
                <li>â€œæ˜¨æ—¥å¤ç”¨â€ï¼šæŠ“å–æœ€æ–°ä¸€æ¡ï¼Œè‡ªåŠ¨æŠŠæ—¥æœŸæ”¹æˆä»Šå¤©</li>
                <li>é¢„è§ˆè·³è½¬ï¼š<code>#/daily-brief/YYYY-MM-DD</code></li>
                <li>åˆ é™¤ï¼š<code>DELETE /api/daily-brief/YYYY-MM-DD.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- å…¶ä»–æ ‡ç­¾é¡µä¿æŒåŸæ ·ï¼ˆå¦‚æœæœªæ¥è¡¥é½ç›¸åº” APIï¼Œæˆ‘å†ç»™ä½ è¡¥ä¸ï¼‰ -->

        <div class="tab" id="tab-analyses">â€¦ï¼ˆä¿æŒä½ åŸæ¥çš„è¡¨å•ï¼‰â€¦</div>
        <div class="tab" id="tab-news">â€¦ï¼ˆä¿æŒä½ åŸæ¥çš„è¡¨å•ï¼‰â€¦</div>
        <div class="tab" id="tab-research">â€¦ï¼ˆä¿æŒä½ åŸæ¥çš„è¡¨å•ï¼‰â€¦</div>
        <div class="tab" id="tab-r-articles">â€¦ï¼ˆä¿æŒä½ åŸæ¥çš„è¡¨å•ï¼‰â€¦</div>

      </section>
    </main>
  </div> <!-- /#admin-root -->

  <!-- ä¸šåŠ¡è„šæœ¬ï¼ˆç™»å½•é—¨ç¦ + ç»Ÿä¸€é‰´æƒå¤´ï¼‰ -->
  <script type="module">
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    // ---------- ç™»å½•é—¨ç¦ ----------
    const overlay = $('#pw-overlay');
    const adminRoot = $('#admin-root');
    const LS_KEY = 'TRAN_ADMIN_PW';

    const saved = localStorage.getItem(LS_KEY);
    if (!saved) {
      overlay.style.display = 'flex';
      adminRoot.style.display = 'none';
    } else {
      overlay.style.display = 'none';
      adminRoot.style.display = 'block';
    }

    $('#pw-enter')?.addEventListener('click', ()=>{
      const v = ($('#admin-pw').value||'').trim();
      if(!v){ $('#pw-err').textContent = 'è¯·è¾“å…¥å£ä»¤'; return; }
      try{ localStorage.setItem(LS_KEY, v); }catch{}
      overlay.style.display = 'none';
      adminRoot.style.display = 'block';
    });

    $('#logout-admin')?.addEventListener('click', ()=>{
      if(!confirm('ç¡®å®šé€€å‡ºç™»å½•ï¼Ÿ')) return;
      try{ localStorage.removeItem(LS_KEY); }catch{}
      location.reload();
    });

    // ---------- é€šç”¨è¯·æ±‚å·¥å…·ï¼ˆè‡ªåŠ¨æºå¸¦ Authorizationï¼‰ ----------
    function authHeader(){
      try{
        const pw = localStorage.getItem(LS_KEY);
        if(!pw) return {};
        return { 'Authorization': 'Bearer ' + pw };
      }catch{ return {}; }
    }
    async function fetchJSON(url, init={}) {
      const headers = Object.assign({ }, authHeader(), init.headers||{});
      const res  = await fetch(url, { cache:'no-store', ...init, headers });
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch {}
      return { res, ok: res.ok, status: res.status, data, text };
    }
    async function getJSON(url) {
      const r = await fetchJSON(url, { method:'GET' });
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      if (!r.data) throw 'å“åº”ä¸æ˜¯ JSON';
      return r.data;
    }
    async function del(url) {
      const r = await fetchJSON(url, { method:'DELETE' });
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      return r.data || {};
    }
    function today(){ return new Date().toISOString().slice(0,10); }

    // ---------- Tabs ----------
    $$('.tab-btn').forEach(b=>{
      b.onclick=()=>{
        $$('.tab-btn').forEach(x=>x.classList.toggle('active', x===b));
        $$('.tab').forEach(t=>t.classList.remove('active'));
        $('#tab-'+b.dataset.tab).classList.add('active');
      };
    });

    // ---------- æœ¬åœ°è‰ç¨¿å­˜å– ----------
    const LS = {
      brief: 'draft.brief.v1'
      // å…¶ä»–æ¨¡å—çš„è‰ç¨¿ key ä¿ç•™å³å¯
    };
    function saveDraft(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function loadDraft(key){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch{return{}} }
    function clearDraft(key){ localStorage.removeItem(key); }
    $('#clear-drafts')?.addEventListener('click', ()=>{
      if(!confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°è‰ç¨¿ç¼“å­˜ï¼Ÿ')) return;
      Object.values(LS).forEach(clearDraft);
      alert('æœ¬åœ°è‰ç¨¿å·²æ¸…ç©º');
    });

    /* ===== Daily Briefï¼ˆå·²å…¨éƒ¨å¯¹æ¥ /api è·¯ç”±ï¼‰ ===== */
    const B = { slug: $('#b-slug'), title: $('#b-title'), bullets: $('#b-bullets'), schedule: $('#b-schedule'), symbol: $('#b-symbol'), interval: $('#b-interval'), msg: $('#b-msg') };
    const bMsg = s => B.msg.textContent = s;
    function bGet(){ return { slug:B.slug.value.trim()||today(), title:B.title.value.trim()||undefined, bullets:B.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean), schedule:B.schedule.value.split('\n').map(s=>s.trim()).filter(Boolean), chart:{ symbol:B.symbol.value.trim()||undefined, interval:B.interval.value } }; }
    function bSet(d){ B.slug.value=d.slug||''; B.title.value=d.title||''; B.bullets.value=(d.bullets||[]).join('\n'); B.schedule.value=(d.schedule||[]).join('\n'); B.symbol.value=(d.chart?.symbol)||d.symbol||''; B.interval.value=(d.chart?.interval)||'60'; }
    $$('#tab-brief input, #tab-brief textarea, #tab-brief select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.brief, bGet())));
    (function(){ const d=loadDraft(LS.brief); if(Object.keys(d).length) bSet(d); })();
    $('#b-clear').onclick = ()=>{ clearDraft(LS.brief); bSet({}); bMsg('è‰ç¨¿å·²æ¸…ç©º'); };

    // å¤ç”¨ï¼šä» /api/daily-brief/index.json è·å–æœ€è¿‘ä¸€æ¡
    $('#b-reuse').onclick = async ()=>{
      bMsg('æ‹‰å–æœ€æ–°ä¸€æ¡â€¦');
      try{
        const arr = await getJSON('/api/daily-brief/index.json?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return bMsg('æ²¡æœ‰å†å²è®°å½•');
        const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].slug : arr[0];
        const d = await getJSON(`/api/daily-brief/${latest}.json?_=${Date.now()}`);
        d.slug = today(); bSet(d); saveDraft(LS.brief, bGet()); bMsg('å·²è½½å…¥æœ€è¿‘ä¸€æ¡ï¼Œå¹¶æŠŠæ—¥æœŸæ”¹ä¸ºä»Šå¤©');
      }catch(e){ bMsg('æ‹‰å–å¤±è´¥ï¼š' + (e?.message || e)); }
    };

    // å‘å¸ƒï¼šPUT /api/daily-brief/:slug.json ï¼ˆå¸¦ Authorizationï¼‰
    $('#b-publish').onclick = async ()=>{
      const payload = bGet();
      const slug = payload.slug || today();
      bMsg('å‘å¸ƒä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        bMsg('âœ… å‘å¸ƒæˆåŠŸ');
      }catch(e){ bMsg('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    $('#b-preview').onclick = ()=> window.open(`/#/daily-brief/${B.slug.value.trim()||today()}`,'_blank','noopener');

    // åˆ é™¤ï¼šDELETE /api/daily-brief/:slug.json ï¼ˆå¸¦ Authorizationï¼‰
    $('#b-delete').onclick = async ()=>{
      const slug=B.slug.value.trim()||today();
      if(!confirm(`ç¡®å®šåˆ é™¤ Daily Brief: ${slug} ?`)) return;
      bMsg('åˆ é™¤ä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        bMsg('ğŸ—‘ï¸ å·²åˆ é™¤');
      }catch(e){ bMsg('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    // ---------- å¿«æ·é”®ï¼šå½“å‰æ ‡ç­¾æ‰§è¡Œå‘å¸ƒ ----------
    document.addEventListener('keydown', e=>{
      if(!(e.key==='Enter'&&(e.ctrlKey||e.metaKey))) return;
      if($('#tab-brief').classList.contains('active')) return $('#b-publish').click();
      // å…¶ä»–æ ‡ç­¾é¡µçš„å‘å¸ƒé€»è¾‘ï¼Œç­‰ç›¸åº” API å®Œæˆåå†ç»‘å®š
    });
  </script>
</body>
</html>
