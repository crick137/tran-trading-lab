<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console Â· TRAN TRADING LAB</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <style>
    :root{ --bg:#0f1115; --card:#15171a; --fg:#eaecee; --muted:#9aa0a6; --bd:#23262b; --primary:#3b82f6; }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
    .container{max-width:1080px; margin:24px auto; padding:0 16px}
    .card{ background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); color:var(--fg); padding:16px; }
    .muted{ color:var(--muted); }
    input,select,textarea{ background:#0f1115; border:1px solid var(--bd); color:#fff; padding:8px 10px; border-radius:10px; outline:none; }
    input:focus,select:focus,textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.2); }
    .icon-btn{ background:transparent; border:1px solid #2a2f36; color:var(--fg); padding:6px 10px; border-radius:8px; cursor:pointer }
    .icon-btn:hover{ background:#1b1f24 }
    button.primary{ padding:10px 14px; border-radius:12px; border:0; background:var(--primary); color:#fff; font-weight:700; cursor:pointer }
    button.primary:hover{ filter:brightness(1.05) }
    .tab-btn{ border:1px solid var(--bd); background:#121418; color:var(--fg); padding:10px 14px; border-radius:10px; cursor:pointer }
    .tab-btn.active{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2) }
    .tab{ display:none } .tab.active{ display:block }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .split{ display:grid; gap:12px; grid-template-columns: 1.2fr .8fr; } @media (max-width: 900px){ .split { grid-template-columns: 1fr } }
    .kbd{ border:1px solid #2a2f36; background:#1b1f24; padding:2px 6px; border-radius:6px; font-size:12px }
    .danger{ color:#f87171; border-color:#f87171 }
    textarea{ min-height: 120px; }
    .form-grid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .form-grid .full{ grid-column: 1 / -1; }

    /* ç™»å½•é®ç½©ï¼ˆé»˜è®¤å¯è§ï¼Œé¿å…è„šæœ¬å¤±è´¥æ—¶ç™½å±ï¼‰ */
    #pw-overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(4px); z-index:9999;
    }
    .login-box{
      width:min(92vw,420px); background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.5)
    }
    .login-box h3{ margin:4px 0 10px }
    .login-box .row{ margin-top:8px }

    /* ä¿é™©ä¸#1ï¼šéšè—ä»»ä½•æ—§â€œå‘å¸ƒå£ä»¤â€æ§ä»¶ */
    .pw-group,.topbar .pw,.topbar .remember,.topbar .clear,.publish-password,#publish-pw,
    input[name="publishPassword"],label[for="publish-pw"]{
      display:none!important; visibility:hidden!important; height:0!important; padding:0!important; margin:0!important; border:0!important;
    }
  </style>
</head>
<body>

  <!-- ç™»å½•é®ç½©ï¼ˆæœªç™»å½•æ˜¾ç¤ºï¼‰ -->
  <div id="pw-overlay">
    <div class="login-box">
      <h3>ç®¡ç†å‘˜ç™»å½•</h3>
      <p class="muted" style="margin:0 0 6px">è¾“å…¥ä¸€æ¬¡å£ä»¤è¿›å…¥åå°ï¼›ç™»å½•åå‘å¸ƒæ— éœ€å†å¡«ã€‚</p>
      <div class="row">
        <input id="admin-pw" type="password" placeholder="ADMIN_PASSWORD" style="flex:1" />
        <button id="pw-enter" class="primary">è¿›å…¥åå°</button>
      </div>
      <p id="pw-err" class="muted" style="color:#f87171; min-height:18px; margin:8px 0 0"></p>
    </div>
  </div>

  <!-- åå°ä¸»ä½“ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <div id="admin-root" style="display:none">
    <main class="admin container">
      <section class="card">
        <h2 style="margin:0 0 10px">Admin Console</h2>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="logout-admin" class="icon-btn">é€€å‡ºç™»å½•</button>
          </div>
          <div class="row" style="align-items:center; gap:10px">
            <div class="muted">è‰ç¨¿è‡ªåŠ¨ä¿å­˜ Â· <span class="kbd">Ctrl/Cmd + Enter</span> å‘å¸ƒ</div>
            <button id="clear-drafts" class="icon-btn danger">æ¸…ç©ºæœ¬åœ°è‰ç¨¿</button>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <button class="tab-btn active" data-tab="brief">Daily Brief</button>
          <button class="tab-btn" data-tab="analyses">Analyses</button>
          <button class="tab-btn" data-tab="news">Market News</button>
          <button class="tab-btn" data-tab="research">Research</button>
          <button class="tab-btn" data-tab="r-articles">Articles</button>
        </div>

        <!-- Daily Brief -->
        <div class="tab active" id="tab-brief">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œä¸å¡«=ä»Šå¤©ï¼‰<input id="b-slug" placeholder="2025-10-18" /></label>
                <label class="full">æ ‡é¢˜<input id="b-title" placeholder="Daily Brief æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" /></label>
                <label class="full">æ ¸å¿ƒè¦ç‚¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="b-bullets"></textarea></label>
                <label class="full">ä»Šæ—¥æ—¥ç¨‹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="b-schedule"></textarea></label>
                <label>å›¾è¡¨ç¬¦å·<input id="b-symbol" placeholder="FX:XAUUSD" /></label>
                <label>å›¾è¡¨å‘¨æœŸ
                  <select id="b-interval">
                    <option value="15">15m</option>
                    <option value="60" selected>1H</option>
                    <option value="240">4H</option>
                    <option value="1D">1D</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="b-publish" class="primary">å‘å¸ƒ</button>
                <button id="b-reuse" class="icon-btn">æ˜¨æ—¥å¤ç”¨</button>
                <button id="b-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="b-delete" class="icon-btn danger">åˆ é™¤è¯¥æ—¥æœŸ</button>
                <button id="b-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="b-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>å‘å¸ƒåˆ° <code>/api/daily-brief/YYYY-MM-DD.json</code></li>
                <li>â€œæ˜¨æ—¥å¤ç”¨â€ï¼šæŠ“å–æœ€æ–°ä¸€æ¡ï¼Œè‡ªåŠ¨æŠŠæ—¥æœŸæ”¹æˆä»Šå¤©</li>
                <li>é¢„è§ˆï¼š<code>#/daily-brief/YYYY-MM-DD</code></li>
                <li>åˆ é™¤ï¼š<code>DELETE /api/daily-brief/YYYY-MM-DD.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Analyses -->
        <div class="tab" id="tab-analyses">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>Slugï¼ˆå”¯ä¸€ï¼Œå¿…å¡«ï¼‰<input id="a-slug" placeholder="xauusd-2025-10-18" /></label>
                <label class="full">æ ‡é¢˜<input id="a-title" placeholder="XAUUSD â€” Range to Trend" /></label>
                <label>ç¬¦å·<input id="a-symbol" placeholder="FX:XAUUSD" /></label>
                <label>æ—¶é—´æ¡†æ¶<input id="a-tf" placeholder="H1 / H4 / 1D" /></label>
                <label>æ—¥æœŸ<input id="a-date" placeholder="2025-10-18" /></label>
                <label>è§‚ç‚¹
                  <select id="a-bias">
                    <option value="bullish">bullish</option>
                    <option value="bearish">bearish</option>
                    <option value="neutral" selected>neutral</option>
                  </select>
                </label>
                <label class="full">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<input id="a-tags" placeholder="gold, FX, liquidity" /></label>
                <label class="full">æ”¯æ’‘ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="a-supports"></textarea></label>
                <label class="full">é˜»åŠ›ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="a-resistances"></textarea></label>
                <label class="full">èƒŒæ™¯ï¼ˆcontextï¼‰<textarea id="a-context"></textarea></label>
                <label class="full">è§‚ç‚¹ï¼ˆviewï¼‰<textarea id="a-view"></textarea></label>
                <label class="full">æ— æ•ˆæ¡ä»¶ï¼ˆinvalidationï¼‰<textarea id="a-invalidation"></textarea></label>
                <label>å›¾è¡¨ç¬¦å·<input id="a-chart-symbol" placeholder="FX:XAUUSD" /></label>
                <label>å›¾è¡¨å‘¨æœŸ
                  <select id="a-chart-interval">
                    <option value="15">15m</option>
                    <option value="60" selected>1H</option>
                    <option value="240">4H</option>
                    <option value="1D">1D</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="a-publish" class="primary">å‘å¸ƒ / æ›´æ–°</button>
                <button id="a-reuse" class="icon-btn">æ˜¨æ—¥å¤ç”¨</button>
                <button id="a-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="a-delete" class="icon-btn danger">åˆ é™¤è¯¥åˆ†æ</button>
                <button id="a-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="a-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>å‘å¸ƒåˆ° <code>/api/analyses/{slug}.json</code></li>
                <li>é¢„è§ˆï¼š<code>#/trade-journal?slug=ä½ çš„slug</code></li>
                <li>åˆ é™¤ï¼š<code>DELETE /api/analyses/{slug}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Market News -->
        <div class="tab" id="tab-news">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>IDï¼ˆå”¯ä¸€ï¼‰<input id="n-id" placeholder="2025-10-18-1 æˆ–è‡ªå®šä¹‰" /></label>
                <label class="full">æ ‡é¢˜<input id="n-title" placeholder="ç¾å›½CPIä¸åŠé¢„æœŸ" /></label>
                <label>æ¥æº<input id="n-source" placeholder="Bloomberg / Reuters ..." /></label>
                <label>å¤–é“¾URL<input id="n-url" placeholder="https://..." /></label>
                <label>æ—¶é—´ï¼ˆISOï¼‰<input id="n-date" placeholder="2025-10-18T12:34:00Z" /></label>
                <label class="full">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<input id="n-tags" placeholder="cpi, usd, gold" /></label>
                <label class="full">æ‘˜è¦<textarea id="n-summary"></textarea></label>
                <label class="full">è¦ç‚¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰<textarea id="n-bullets"></textarea></label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="n-publish" class="primary">å‘å¸ƒ / æ›´æ–°</button>
                <button id="n-reuse" class="icon-btn">æ˜¨æ—¥å¤ç”¨</button>
                <button id="n-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="n-delete" class="icon-btn danger">åˆ é™¤è¯¥å¿«è®¯</button>
                <button id="n-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="n-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>å‘å¸ƒåˆ° <code>/api/market-news/{id}.json</code></li>
                <li>åˆ—è¡¨é¡µï¼š<code>#/market-news</code></li>
                <li>åˆ é™¤ï¼š<code>DELETE /api/market-news/{id}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Researchï¼ˆSyllabusï¼‰ -->
        <div class="tab" id="tab-research">
          <div class="split">
            <div>
              <div class="form-grid">
                <label class="full">Syllabus JSONï¼ˆæ•°ç»„ï¼‰
                  <textarea id="r-json" style="min-height:420px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="r-load" class="icon-btn">è½½å…¥çº¿ä¸Šç‰ˆæœ¬</button>
                <button id="r-save" class="primary">ä¿å­˜</button>
                <button id="r-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="r-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="r-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>ä¿å­˜åˆ° <code>/api/research/syllabus</code></li>
                <li>é¢„è§ˆï¼š<code>#/knowledge-lab</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Research Articles -->
        <div class="tab" id="tab-r-articles">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>Slugï¼ˆå”¯ä¸€ï¼Œå¿…å¡«ï¼‰<input id="ra-slug" placeholder="smc-order-blocks" /></label>
                <label class="full">æ ‡é¢˜<input id="ra-title" placeholder="Order Blocks å…¨è§£æ" /></label>
                <label class="full">æ‘˜è¦ï¼ˆç”¨äºåˆ—è¡¨/SEOï¼‰<textarea id="ra-excerpt"></textarea></label>
                <label class="full">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<input id="ra-tags" placeholder="smc, ob, liquidity" /></label>
                <label class="full">ä¸»å›¾ URLï¼ˆå¯é€‰ï¼‰<input id="ra-hero" placeholder="https://â€¦" /></label>
                <label class="full">æ­£æ–‡ï¼ˆMarkdownï¼‰
                  <textarea id="ra-body" style="min-height:360px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="ra-publish" class="primary">å‘å¸ƒ / æ›´æ–°</button>
                <button id="ra-reuse" class="icon-btn">æ˜¨æ—¥å¤ç”¨</button>
                <button id="ra-preview" class="icon-btn">ä¸€é”®é¢„è§ˆ</button>
                <button id="ra-delete" class="icon-btn danger">åˆ é™¤è¯¥æ–‡ç« </button>
                <button id="ra-clear" class="icon-btn">æ¸…ç©ºè‰ç¨¿</button>
              </div>
              <p class="muted" id="ra-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">è¯´æ˜</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>å‘å¸ƒåˆ° <code>/api/research/articles/{slug}.json</code></li>
                <li>ç´¢å¼•ï¼š<code>/api/research/articles/index</code></li>
                <li>åˆ é™¤ï¼š<code>DELETE /api/research/articles/{slug}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- ä¸šåŠ¡è„šæœ¬ -->
  <script type="module">
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    /* æˆæƒä¸ç»Ÿä¸€ Fetchï¼ˆè‡ªåŠ¨å¸¦ Cookie + Authorization + è¶…æ—¶ï¼‰ */
    let ADMIN_TOKEN = sessionStorage.getItem('tran_admin_token') || '';
    function setAdminToken(tok){ ADMIN_TOKEN = tok || ''; if(tok){ sessionStorage.setItem('tran_admin_token', tok); } else { sessionStorage.removeItem('tran_admin_token'); } }

    async function apiFetch(url, init = {}) {
      const timeoutMs = 12000; // å‰ç«¯è¯·æ±‚è¶…æ—¶ï¼ˆ12sï¼‰
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(new DOMException('timeout','AbortError')), timeoutMs);
      const headers = new Headers(init.headers || {});
      if (ADMIN_TOKEN) headers.set('Authorization', 'Bearer ' + ADMIN_TOKEN);
      try{
        const res  = await fetch(url, { credentials: 'include', cache: 'no-store', ...init, headers, signal: ctrl.signal });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        return { res, ok: res.ok, status: res.status, data, text };
      } finally {
        clearTimeout(id);
      }
    }
    const fetchJSON = (url, init={}) => apiFetch(url, init);
    async function getJSON(url){
      const r = await apiFetch(url);
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      if (!r.data) throw 'å“åº”ä¸æ˜¯ JSON';
      return r.data;
    }
    const today = ()=> new Date().toISOString().slice(0,10);

    /* ç™»å½•é—¨ç¦ */
    const overlay  = $('#pw-overlay');
    const adminRoot= $('#admin-root');

    async function syncLoginUI(){
      try{
        const j = await getJSON('/api/admin/verify?_=' + Date.now());
        const authed = !!j.authed;
        overlay.style.display   = authed ? 'none'  : 'flex';
        adminRoot.style.display = authed ? 'block' : 'none';
        return authed;
      }catch{
        overlay.style.display   = 'flex';
        adminRoot.style.display = 'none';
        return false;
      }
    }

    $('#pw-enter')?.addEventListener('click', async ()=>{
      const pw = ($('#admin-pw').value||'').trim();
      if (!pw) { $('#pw-err').textContent = 'è¯·è¾“å…¥å£ä»¤'; return; }
      $('#pw-err').textContent = 'ç™»å½•ä¸­â€¦';
      try{
        const { res, data, text } = await apiFetch('/api/admin/login', {
          method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ password: pw })
        });
        if (!res.ok || !data?.ok) throw new Error(data?.error || text || `HTTP ${res.status}`);
        // ç”¨ç™»å½•å£ä»¤ä½œä¸ºéšåçš„ Bearer tokenï¼Œé…åˆåç«¯å†™å…¥é‰´æƒ
        setAdminToken(pw);
        await syncLoginUI();
        $('#pw-err').textContent = '';
        $('#admin-pw').value = '';
      }catch(e){
        $('#pw-err').textContent = 'ç™»å½•å¤±è´¥ï¼š' + (e?.message || e);
      }
    });

    $('#logout-admin')?.addEventListener('click', async ()=>{
      if (!confirm('ç¡®å®šé€€å‡ºç™»å½•ï¼Ÿ')) return;
      try{ await apiFetch('/api/admin/logout', { method:'POST' }); }catch{}
      setAdminToken('');
      location.reload();
    });

    /* å®‰å…¨å¯åŠ¨ï¼ˆé¿å…é¡¶å±‚ await é€ æˆç™½å±ï¼‰ */
    (async () => {
      try { await syncLoginUI(); }
      catch (e) {
        console.error('[syncLoginUI] failed:', e);
        overlay.style.display   = 'flex';
        adminRoot.style.display = 'none';
      }
    })();

    /* ä¿é™©ä¸#2ï¼šç§»é™¤ä»»ä½•æ—§çš„å£ä»¤æ¡ DOM */
    (function removeLegacyPwBar(){
      const selectors = [
        '.pw-group','.topbar .pw','.topbar .remember','.topbar .clear',
        '#publish-pw','input[name="publishPassword"]','label[for="publish-pw"]','.publish-password'
      ];
      selectors.forEach(sel=> document.querySelectorAll(sel).forEach(el=> el.remove()));
      document.querySelectorAll('.topbar').forEach(tb=>{
        if(!tb.textContent.trim() || tb.children.length === 0) tb.remove();
      });
    })();

    /* Tabs */
    $$('.tab-btn').forEach(b=>{
      b.onclick=()=>{
        $$('.tab-btn').forEach(x=>x.classList.toggle('active', x===b));
        $$('.tab').forEach(t=>t.classList.remove('active'));
        $('#tab-'+b.dataset.tab).classList.add('active');
      };
    });

    /* è‰ç¨¿å·¥å…· */
    const LS = {
      brief:'draft.brief.v1', analyses:'draft.analyses.v1',
      news:'draft.news.v1',   research:'draft.research.v1',
      rArticles:'draft.research.articles.v1'
    };
    const saveDraft =(k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const loadDraft = k => { try{return JSON.parse(localStorage.getItem(k)||'{}')}catch{return{}} };
    const clearDraft= k => localStorage.removeItem(k);
    $('#clear-drafts')?.addEventListener('click', ()=>{
      if(!confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°è‰ç¨¿ç¼“å­˜ï¼Ÿ')) return;
      Object.values(LS).forEach(clearDraft);
      alert('æœ¬åœ°è‰ç¨¿å·²æ¸…ç©º');
    });

    /* ===== Daily Brief ===== */
    const B = { slug:$('#b-slug'), title:$('#b-title'), bullets:$('#b-bullets'), schedule:$('#b-schedule'),
                symbol:$('#b-symbol'), interval:$('#b-interval'), msg:$('#b-msg') };
    const bMsg = s => B.msg.textContent = s;
    const bGet = ()=>({
      slug:B.slug.value.trim()||today(),
      title:B.title.value.trim()||undefined,
      bullets:B.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean),
      schedule:B.schedule.value.split('\n').map(s=>s.trim()).filter(Boolean),
      chart:{ symbol:B.symbol.value.trim()||undefined, interval:B.interval.value }
    });
    function bSet(d){
      B.slug.value=d.slug||''; B.title.value=d.title||'';
      B.bullets.value=(d.bullets||[]).join('\n');
      B.schedule.value=(d.schedule||[]).join('\n');
      B.symbol.value=(d.chart?.symbol)||d.symbol||'';
      B.interval.value=(d.chart?.interval)||'60';
    }
    $$('#tab-brief input, #tab-brief textarea, #tab-brief select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.brief, bGet())));
    (function(){ const d=loadDraft(LS.brief); if(Object.keys(d).length) bSet(d); })();
    $('#b-clear').onclick = ()=>{ clearDraft(LS.brief); bSet({}); bMsg('è‰ç¨¿å·²æ¸…ç©º'); };

    $('#b-reuse').onclick = async ()=>{
      bMsg('æ‹‰å–æœ€æ–°ä¸€æ¡â€¦');
      try{
        const arr = await getJSON('/api/daily-brief/index?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return bMsg('æ²¡æœ‰å†å²è®°å½•');
        const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].slug : arr[0];
        const d = await getJSON(`/api/daily-brief/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
        d.slug = today(); bSet(d); saveDraft(LS.brief, bGet()); bMsg('å·²è½½å…¥æœ€è¿‘ä¸€æ¡ï¼Œå¹¶æŠŠæ—¥æœŸæ”¹ä¸ºä»Šå¤©');
      }catch(e){ bMsg('æ‹‰å–å¤±è´¥ï¼š' + (e?.message || e)); }
    };

    $('#b-publish').onclick = async ()=>{
      const payload = bGet();
      const slug = payload.slug || today();
      bMsg('å‘å¸ƒä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, {
          method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        bMsg('âœ… å‘å¸ƒæˆåŠŸ');
      }catch(e){ bMsg('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    $('#b-preview').onclick = ()=> window.open(`/#/daily-brief/${B.slug.value.trim()||today()}`,'_blank','noopener');

    $('#b-delete').onclick = async ()=>{
      const slug=B.slug.value.trim()||today();
      if(!confirm(`ç¡®å®šåˆ é™¤ Daily Brief: ${slug} ?`)) return;
      bMsg('åˆ é™¤ä¸­â€¦');
      try{
        const del = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
        if(!del.res.ok) throw new Error((del.data && (del.data.error||del.data.message)) || `HTTP ${del.res.status}`);
        // é¢å¤–æ ¡éªŒï¼šç¡®è®¤å·²ä¸å­˜åœ¨
        const check = await apiFetch(`/api/daily-brief/${encodeURIComponent(slug)}.json`, { method:'GET' });
        if (check.ok) {
          throw new Error('DELETE_VERIFY_FAILED');
        }
        bMsg('ğŸ—‘ï¸ å·²åˆ é™¤');
      }catch(e){ bMsg('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    /* ===== Analyses ===== */
    const A = { slug:$('#a-slug'), title:$('#a-title'), symbol:$('#a-symbol'), tf:$('#a-tf'), date:$('#a-date'),
                bias:$('#a-bias'), tags:$('#a-tags'), supports:$('#a-supports'), resistances:$('#a-resistances'),
                context:$('#a-context'), view:$('#a-view'), invalidation:$('#a-invalidation'),
                chartSymbol:$('#a-chart-symbol'), chartInterval:$('#a-chart-interval'), msg:$('#a-msg') };
    const aMsg = s => A.msg.textContent = s;
    const aGet = ()=>({
      slug:A.slug.value.trim(), title:A.title.value.trim(), symbol:A.symbol.value.trim(),
      tf:A.tf.value.trim(), date:A.date.value.trim()||today(), bias:A.bias.value,
      tags:A.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
      supports:A.supports.value.split('\n').map(s=>s.trim()).filter(Boolean),
      resistances:A.resistances.value.split('\n').map(s=>s.trim()).filter(Boolean),
      context:A.context.value.trim(), view:A.view.value.trim(), invalidation:A.invalidation.value.trim(),
      chart:{ symbol:A.chartSymbol.value.trim()||A.symbol.value.trim(), interval:A.chartInterval.value }
    });
    function aSet(d){
      A.slug.value=d.slug||''; A.title.value=d.title||''; A.symbol.value=d.symbol||'';
      A.tf.value=d.tf||''; A.date.value=d.date||''; A.bias.value=d.bias||'neutral';
      A.tags.value=(d.tags||[]).join(', ');
      A.supports.value=(d.supports||[]).join('\n');
      A.resistances.value=(d.resistances||[]).join('\n');
      A.context.value=d.context||''; A.view.value=d.view||'';
      A.invalidation.value=d.invalidation||'';
      A.chartSymbol.value=(d.chart?.symbol)||'';
      A.chartInterval.value=(d.chart?.interval)||'60';
    }
    $$('#tab-analyses input, #tab-analyses textarea, #tab-analyses select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.analyses, aGet())));
    (function(){ const d=loadDraft(LS.analyses); if(Object.keys(d).length) aSet(d); })();
    $('#a-clear').onclick = ()=>{ clearDraft(LS.analyses); aSet({}); aMsg('è‰ç¨¿å·²æ¸…ç©º'); };

    $('#a-reuse').onclick = async ()=>{
      aMsg('æ‹‰å–æœ€æ–°ä¸€æ¡â€¦');
      try{
        const arr = await getJSON('/api/analyses/index?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return aMsg('æ²¡æœ‰å†å²è®°å½•');
        const latest = arr[0].slug || arr[0];
        const d = await getJSON(`/api/analyses/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
        const base=(d.symbol||'idea').toLowerCase().replace(/[^a-z0-9]+/g,'');
        d.slug=`${base}-${today()}`; d.date=today();
        aSet(d); saveDraft(LS.analyses, aGet());
        aMsg('å·²è½½å…¥æœ€è¿‘ä¸€æ¡ï¼Œslug/æ—¥æœŸå·²æ›´æ–°ä¸ºä»Šå¤©');
      }catch{
        aMsg('æ‹‰å–å¤±è´¥');
      }
    };

    $('#a-publish').onclick = async ()=>{
      const payload=aGet(); if(!payload.slug) return aMsg('è¯·å¡«å†™ slug');
      aMsg('å‘å¸ƒä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/analyses/${encodeURIComponent(payload.slug)}.json`, {
          method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        aMsg('âœ… å‘å¸ƒæˆåŠŸ');
      }catch(e){ aMsg('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    $('#a-preview').onclick = ()=>{
      const slug=A.slug.value.trim(); if(!slug) return aMsg('è¯·å…ˆå¡«å†™ slug');
      window.open(`/#/trade-journal?slug=${encodeURIComponent(slug)}`,'_blank','noopener');
    };

    $('#a-delete').onclick = async ()=>{
      const slug=A.slug.value.trim(); if(!slug) return aMsg('è¯·å…ˆå¡«å†™ slug');
      if(!confirm(`ç¡®å®šåˆ é™¤åˆ†æï¼š${slug} ?`)) return;
      aMsg('åˆ é™¤ä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/analyses/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        aMsg('ğŸ—‘ï¸ å·²åˆ é™¤');
      }catch(e){ aMsg('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    /* ===== Market News ===== */
    const N = { id:$('#n-id'), title:$('#n-title'), source:$('#n-source'), url:$('#n-url'),
                date:$('#n-date'), tags:$('#n-tags'), summary:$('#n-summary'), bullets:$('#n-bullets'), msg:$('#n-msg') };
    const nMsg = s => N.msg.textContent = s;
    const nGet = ()=>({
      id:N.id.value.trim(), title:N.title.value.trim(), source:N.source.value.trim(),
      url:N.url.value.trim(), date:N.date.value.trim()||new Date().toISOString(),
      tags:N.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
      summary:N.summary.value.trim(),
      bullets:N.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean)
    });
    function nSet(d){
      N.id.value=d.id||''; N.title.value=d.title||''; N.source.value=d.source||'';
      N.url.value=d.url||''; N.date.value=d.date||''; N.tags.value=(d.tags||[]).join(', ');
      N.summary.value=d.summary||''; N.bullets.value=(d.bullets||[]).join('\n');
    }
    $$('#tab-news input, #tab-news textarea').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.news, nGet())));
    (function(){ const d=loadDraft(LS.news); if(Object.keys(d).length) nSet(d); })();
    $('#n-clear').onclick = ()=>{ clearDraft(LS.news); nSet({}); nMsg('è‰ç¨¿å·²æ¸…ç©º'); };

    $('#n-reuse').onclick = async ()=>{
      nMsg('æ‹‰å–æœ€æ–°ä¸€æ¡â€¦');
      try{
        const arr = await getJSON('/api/market-news/index?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return nMsg('æ²¡æœ‰å†å²è®°å½•');
        const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].id : arr[0];
        const d = await getJSON(`/api/market-news/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
        const base = new Date().toISOString().slice(0,10);
        d.id = `${base}-1`; d.date = new Date().toISOString();
        nSet(d); saveDraft(LS.news, nGet());
        nMsg('å·²è½½å…¥æœ€è¿‘ä¸€æ¡ï¼Œå·²å»ºè®®æ–°çš„ id');
      }catch(e){ nMsg('æ‹‰å–å¤±è´¥ï¼š' + (e?.message || e)); }
    };

    $('#n-publish').onclick = async ()=>{
      const payload = nGet(); if(!payload.id) return nMsg('è¯·å¡«å†™ id');
      nMsg('å‘å¸ƒä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/market-news/${encodeURIComponent(payload.id)}.json`, {
          method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        nMsg('âœ… å‘å¸ƒæˆåŠŸ');
      }catch(e){ nMsg('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    $('#n-preview').onclick = ()=> window.open('/#/market-news','_blank','noopener');

    $('#n-delete').onclick = async ()=>{
      const id=N.id.value.trim(); if(!id) return nMsg('è¯·å…ˆå¡«å†™ id');
      if(!confirm(`ç¡®å®šåˆ é™¤å¿«è®¯ï¼š${id} ?`)) return;
      nMsg('åˆ é™¤ä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/market-news/${encodeURIComponent(id)}.json`, { method:'DELETE' });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        nMsg('ğŸ—‘ï¸ å·²åˆ é™¤');
      }catch(e){ nMsg('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    /* ===== Research (syllabus) ===== */
    const R = { json:$('#r-json'), msg:$('#r-msg') };
    const rMsg = s => R.msg.textContent = s;
    const rGet = ()=>{ try{ return JSON.parse(R.json.value) }catch{ return null } };
    $$('#tab-research textarea').forEach(el=> el.addEventListener('input', ()=> localStorage.setItem(LS.research, JSON.stringify({text:R.json.value}))));
    (function(){ try{ const d = JSON.parse(localStorage.getItem(LS.research)||'{}'); if(d && typeof d.text==='string') R.json.value=d.text; }catch{} })();
    $('#r-load').onclick = async ()=>{
      rMsg('åŠ è½½çº¿ä¸Šå¤§çº²â€¦');
      try{
        const j = await getJSON('/api/research/syllabus?_=' + Date.now());
        R.json.value = JSON.stringify(j.syllabus||[], null, 2);
        localStorage.setItem(LS.research, JSON.stringify({text: R.json.value}));
        rMsg('å·²è½½å…¥çº¿ä¸Šç‰ˆæœ¬åˆ°ç¼–è¾‘æ¡†');
      }catch(e){ rMsg('åŠ è½½å¤±è´¥ï¼š' + (e?.message || e)); }
    };
    $('#r-save').onclick = async ()=>{
      const syllabus = rGet(); if (!Array.isArray(syllabus)) return rMsg('JSON æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æ•°ç»„');
      rMsg('ä¿å­˜ä¸­â€¦');
      try{
        const { res, data } = await fetchJSON('/api/research/syllabus', {
          method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ syllabus })
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        rMsg('âœ… ä¿å­˜æˆåŠŸ');
      }catch(e){ rMsg('âŒ ä¿å­˜å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };
    $('#r-clear').onclick = ()=>{ localStorage.removeItem(LS.research); R.json.value=''; rMsg('è‰ç¨¿å·²æ¸…ç©º'); };
    $('#r-preview').onclick = ()=> window.open('/#/knowledge-lab','_blank','noopener');

    /* ===== Research Articles ===== */
    const RA = { slug:$('#ra-slug'), title:$('#ra-title'), excerpt:$('#ra-excerpt'),
                 tags:$('#ra-tags'), hero:$('#ra-hero'), body:$('#ra-body'), msg:$('#ra-msg') };
    const raMsg = s => RA.msg.textContent = s;
    const raGet = ()=>({
      slug:(RA.slug.value||'').trim(), title:(RA.title.value||'').trim(), excerpt:(RA.excerpt.value||'').trim(),
      tags:(RA.tags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
      hero:(RA.hero.value||'').trim(), date:new Date().toISOString(), body: RA.body.value || ''
    });
    const raSet = d => {
      RA.slug.value=d.slug||''; RA.title.value=d.title||'';
      RA.excerpt.value=d.excerpt||''; RA.tags.value=(d.tags||[]).join(', ');
      RA.hero.value=d.hero||''; RA.body.value=d.body||'';
    };
    $$('#tab-r-articles input, #tab-r-articles textarea').forEach(el=> el.addEventListener('input', ()=> localStorage.setItem(LS.rArticles, JSON.stringify(raGet()))));
    (function(){ try{ const d=JSON.parse(localStorage.getItem(LS.rArticles)||'{}'); if(Object.keys(d).length) raSet(d); }catch{} })();
    $('#ra-clear').onclick = ()=>{ localStorage.removeItem(LS.rArticles); raSet({}); raMsg('è‰ç¨¿å·²æ¸…ç©º'); };

    $('#ra-reuse').onclick = async ()=>{
      raMsg('æ‹‰å–æœ€æ–°ä¸€ç¯‡â€¦');
      try{
        const list = await getJSON('/api/research/articles/index?_=' + Date.now());
        if(!Array.isArray(list)||!list.length) return raMsg('æ²¡æœ‰å†å²è®°å½•');
        const latestSlug = list[0].slug || list[0];
        const d = await getJSON(`/api/research/articles/${encodeURIComponent(latestSlug)}.json?_=${Date.now()}`);
        const base=(d.slug||'article').replace(/[^a-z0-9\-]+/gi,'');
        d.slug=base+'-'+today(); d.date=new Date().toISOString();
        raSet(d); localStorage.setItem(LS.rArticles, JSON.stringify(raGet()));
        raMsg('å·²è½½å…¥æœ€è¿‘ä¸€ç¯‡ï¼Œå·²å»ºè®®æ–°çš„ slug');
      }catch(e){ raMsg('æ‹‰å–å¤±è´¥ï¼š' + (e?.message || e)); }
    };

    $('#ra-publish').onclick = async ()=>{
      const payload=raGet(); if(!payload.slug) return raMsg('è¯·å¡«å†™ slug');
      raMsg('å‘å¸ƒä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/research/articles/${encodeURIComponent(payload.slug)}.json`, {
          method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        raMsg('âœ… å‘å¸ƒæˆåŠŸ');
      }catch(e){ raMsg('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    $('#ra-preview').onclick = ()=>{
      const slug=(RA.slug.value||'').trim(); if(!slug) return raMsg('è¯·å…ˆå¡«å†™ slug');
      window.open(`/api/research/articles/${encodeURIComponent(slug)}.json`, '_blank', 'noopener');
    };

    $('#ra-delete').onclick = async ()=>{
      const slug=RA.slug.value.trim(); if(!slug) return raMsg('è¯·å…ˆå¡«å†™ slug');
      if(!confirm(`ç¡®å®šåˆ é™¤æ–‡ç« ï¼š${slug} ?`)) return;
      raMsg('åˆ é™¤ä¸­â€¦');
      try{
        const { res, data } = await fetchJSON(`/api/research/articles/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
        if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
        raMsg('ğŸ—‘ï¸ å·²åˆ é™¤');
      }catch(e){ raMsg('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e || 'Unknown')); }
    };

    /* å¿«æ·é”®ï¼šCtrl/Cmd + Enter */
    document.addEventListener('keydown', e=>{
      if(!(e.key==='Enter'&&(e.ctrlKey||e.metaKey))) return;
      if($('#tab-brief').classList.contains('active')) return $('#b-publish').click();
      if($('#tab-analyses').classList.contains('active')) return $('#a-publish').click();
      if($('#tab-news').classList.contains('active')) return $('#n-publish').click();
      if($('#tab-research').classList.contains('active')) return $('#r-save').click();
      if($('#tab-r-articles').classList.contains('active')) return $('#ra-publish').click();
    });
  </script>
</body>
</html>
