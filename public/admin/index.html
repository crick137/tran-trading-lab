<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console · TRAN TRADING LAB</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <style>
    :root{ --bg:#0f1115; --card:#15171a; --fg:#eaecee; --muted:#9aa0a6; --bd:#23262b; --primary:#3b82f6; }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
    .container{max-width:1040px; margin:24px auto; padding:0 16px}
    .card{ background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); color:var(--fg); }
    .muted{ color:var(--muted); }
    input,select,textarea{ background:#0f1115; border:1px solid var(--bd); color:#fff; padding:8px 10px; border-radius:10px; outline:none; }
    input:focus,select:focus,textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.2); }
    .icon-btn{ background:transparent; border:1px solid #2a2f36; color:var(--fg); padding:6px 10px; border-radius:8px; cursor:pointer }
    .icon-btn:hover{ background:#1b1f24 }
    button.primary{ padding:10px 14px; border-radius:12px; border:0; background:var(--primary); color:#fff; font-weight:700; cursor:pointer }
    button.primary:hover{ filter:brightness(1.05) }
    .tab-btn{ border:1px solid var(--bd); background:#121418; color:var(--fg); padding:10px 14px; border-radius:10px; cursor:pointer }
    .tab-btn.active{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2) }
    .tab{ display:none } .tab.active{ display:block }
    textarea{ min-height: 120px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .hint{ font-size:12px; opacity:.75 }
    .split{ display:grid; gap:12px; grid-template-columns: 1.2fr .8fr; } @media (max-width: 900px){ .split { grid-template-columns: 1fr } }
    .kbd{ border:1px solid #2a2f36; background:#1b1f24; padding:2px 6px; border-radius:6px; font-size:12px }
    .danger{ color:#f87171; border-color:#f87171 }

    /* 登录遮罩 */
    #pw-overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(4px); z-index:9999;
    }
    .login-box{
      width:min(92vw,420px); background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.5)
    }
    .login-box h3{ margin:4px 0 10px }
    .login-box .row{ margin-top:8px }
  </style>
</head>
<body>

  <!-- 登录遮罩：未登录时显示 -->
  <div id="pw-overlay" style="display:none">
    <div class="login-box">
      <h3>管理员登录</h3>
      <p class="muted" style="margin:0 0 6px">进入后台前需输入一次口令；进入后发布无需再填。</p>
      <div class="row">
        <input id="admin-pw" type="password" placeholder="ADMIN_PASSWORD" style="flex:1" />
        <button id="pw-enter" class="primary">进入后台</button>
      </div>
      <p id="pw-err" class="muted" style="color:#f87171; min-height:18px; margin:8px 0 0"></p>
    </div>
  </div>

  <!-- 后台主体：登录后显示 -->
  <div id="admin-root" style="display:none">
    <main class="admin container">
      <section class="card" style="padding:16px">
        <h2 style="margin:0 0 10px">Admin Console</h2>

        <!-- 顶部工具栏 -->
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <!-- 原“发布口令”输入已移除（进入后台前就已输入并缓存） -->
            <button id="logout-admin" class="icon-btn">退出登录</button>
          </div>
          <div class="row" style="align-items:center; gap:10px">
            <div class="muted">草稿自动保存 · <span class="kbd">Ctrl/Cmd + Enter</span> 发布</div>
            <button id="clear-drafts" class="icon-btn danger">清空本地草稿</button>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <button class="tab-btn active" data-tab="brief">Daily Brief</button>
          <button class="tab-btn" data-tab="analyses">Analyses</button>
          <button class="tab-btn" data-tab="news">Market News</button>
          <button class="tab-btn" data-tab="research">Research</button>
          <button class="tab-btn" data-tab="r-articles">Articles</button>
        </div>

        <!-- Daily Brief -->
        <div class="tab active" id="tab-brief">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>日期（YYYY-MM-DD，不填=今天）<input id="b-slug" placeholder="2025-10-18" /></label>
                <label class="full">标题<input id="b-title" placeholder="Daily Brief 标题（可选）" /></label>
                <label class="full">核心要点（每行一条）<textarea id="b-bullets"></textarea></label>
                <label class="full">今日日程（每行一条）<textarea id="b-schedule"></textarea></label>
                <label>图表符号<input id="b-symbol" placeholder="FX:XAUUSD" /></label>
                <label>图表周期
                  <select id="b-interval">
                    <option value="15">15m</option>
                    <option value="60" selected>1H</option>
                    <option value="240">4H</option>
                    <option value="1D">1D</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="b-publish" class="primary">发布</button>
                <button id="b-reuse" class="icon-btn">昨日复用</button>
                <button id="b-preview" class="icon-btn">一键预览</button>
                <button id="b-delete" class="icon-btn danger">删除该日期</button>
                <button id="b-clear" class="icon-btn">清空草稿</button>
              </div>
              <p class="muted" id="b-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">说明</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>发布到 <code>/daily-brief/YYYY-MM-DD.json</code>（前端会自动附带 Authorization 头）</li>
                <li>“昨日复用”：抓取最新一条，自动把日期改成今天</li>
                <li>预览跳转：<code>#/daily-brief/YYYY-MM-DD</code></li>
                <li>删除：<code>DELETE /daily-brief/YYYY-MM-DD.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Analyses -->
        <div class="tab" id="tab-analyses">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>Slug（唯一，必填）<input id="a-slug" placeholder="xauusd-2025-10-18" /></label>
                <label class="full">标题<input id="a-title" placeholder="XAUUSD — Range to Trend" /></label>
                <label>符号<input id="a-symbol" placeholder="FX:XAUUSD" /></label>
                <label>时间框架<input id="a-tf" placeholder="H1 / H4 / 1D" /></label>
                <label>日期<input id="a-date" placeholder="2025-10-18" /></label>
                <label>观点
                  <select id="a-bias">
                    <option value="bullish">bullish</option>
                    <option value="bearish">bearish</option>
                    <option value="neutral" selected>neutral</option>
                  </select>
                </label>
                <label class="full">标签（逗号分隔）<input id="a-tags" placeholder="gold, FX, liquidity" /></label>
                <label class="full">支撑（每行一条）<textarea id="a-supports"></textarea></label>
                <label class="full">阻力（每行一条）<textarea id="a-resistances"></textarea></label>
                <label class="full">背景（context）<textarea id="a-context"></textarea></label>
                <label class="full">观点（view）<textarea id="a-view"></textarea></label>
                <label class="full">无效条件（invalidation）<textarea id="a-invalidation"></textarea></label>
                <label>图表符号<input id="a-chart-symbol" placeholder="FX:XAUUSD" /></label>
                <label>图表周期
                  <select id="a-chart-interval">
                    <option value="15">15m</option>
                    <option value="60" selected>1H</option>
                    <option value="240">4H</option>
                    <option value="1D">1D</option>
                  </select>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="a-publish" class="primary">发布 / 更新</button>
                <button id="a-reuse" class="icon-btn">昨日复用</button>
                <button id="a-preview" class="icon-btn">一键预览</button>
                <button id="a-delete" class="icon-btn danger">删除该分析</button>
                <button id="a-clear" class="icon-btn">清空草稿</button>
              </div>
              <p class="muted" id="a-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">说明</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>发布到 <code>/analyses/{slug}.json</code></li>
                <li>预览跳转：<code>#/trade-journal?slug=你的slug</code></li>
                <li>删除：<code>DELETE /analyses/{slug}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Market News -->
        <div class="tab" id="tab-news">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>ID（唯一）<input id="n-id" placeholder="2025-10-18-1 或自定义" /></label>
                <label class="full">标题<input id="n-title" placeholder="美国CPI不及预期" /></label>
                <label>来源<input id="n-source" placeholder="Bloomberg / Reuters ..." /></label>
                <label>外链URL<input id="n-url" placeholder="https://..." /></label>
                <label>时间（ISO）<input id="n-date" placeholder="2025-10-18T12:34:00Z" /></label>
                <label class="full">标签（逗号分隔）<input id="n-tags" placeholder="cpi, usd, gold" /></label>
                <label class="full">摘要<textarea id="n-summary"></textarea></label>
                <label class="full">要点（每行一条）<textarea id="n-bullets"></textarea></label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="n-publish" class="primary">发布 / 更新</button>
                <button id="n-reuse" class="icon-btn">昨日复用</button>
                <button id="n-preview" class="icon-btn">一键预览</button>
                <button id="n-delete" class="icon-btn danger">删除该快讯</button>
                <button id="n-clear" class="icon-btn">清空草稿</button>
              </div>
              <p class="muted" id="n-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">说明</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>发布到 <code>/market-news/{id}.json</code></li>
                <li>列表页：<code>#/market-news</code></li>
                <li>删除：<code>DELETE /market-news/{id}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Research（Syllabus） -->
        <div class="tab" id="tab-research">
          <div class="split">
            <div>
              <div class="form-grid">
                <label class="full">Syllabus JSON（数组）
                  <textarea id="r-json" style="min-height:420px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="r-load" class="icon-btn">载入线上版本</button>
                <button id="r-save" class="primary">保存</button>
                <button id="r-preview" class="icon-btn">一键预览</button>
                <button id="r-clear" class="icon-btn">清空草稿</button>
              </div>
              <p class="muted" id="r-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">说明</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>保存到 <code>/research/syllabus.json</code></li>
                <li>预览跳转：<code>#/knowledge-lab</code></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Research Articles -->
        <div class="tab" id="tab-r-articles">
          <div class="split">
            <div>
              <div class="form-grid">
                <label>Slug（唯一，必填）
                  <input id="ra-slug" placeholder="smc-order-blocks" />
                </label>
                <label class="full">标题
                  <input id="ra-title" placeholder="Order Blocks 全解析" />
                </label>
                <label class="full">摘要（用于列表/SEO）
                  <textarea id="ra-excerpt"></textarea>
                </label>
                <label class="full">标签（逗号分隔）
                  <input id="ra-tags" placeholder="smc, ob, liquidity" />
                </label>
                <label class="full">主图 URL（可选）
                  <input id="ra-hero" placeholder="https://…" />
                </label>
                <label class="full">正文（Markdown）
                  <textarea id="ra-body" style="min-height:360px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
                </label>
              </div>
              <div class="row" style="margin-top:10px">
                <button id="ra-publish" class="primary">发布 / 更新</button>
                <button id="ra-reuse" class="icon-btn">昨日复用</button>
                <button id="ra-preview" class="icon-btn">一键预览</button>
                <button id="ra-delete" class="icon-btn danger">删除该文章</button>
                <button id="ra-clear" class="icon-btn">清空草稿</button>
              </div>
              <p class="muted" id="ra-msg" style="margin-top:10px"></p>
            </div>
            <div class="card" style="padding:12px">
              <h3 style="margin-top:0">说明</h3>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>发布到 <code>/research/articles/{slug}.json</code></li>
                <li>索引：<code>/research/articles/index.json</code></li>
                <li>删除：<code>DELETE /research/articles/{slug}.json</code></li>
              </ul>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div> <!-- /#admin-root -->

  <!-- 业务脚本（登录门禁 + 统一鉴权头） -->
  <script type="module">
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    // ---------- 登录门禁 ----------
    const overlay = $('#pw-overlay');
    const adminRoot = $('#admin-root');
    const LS_KEY = 'TRAN_ADMIN_PW';

    const saved = localStorage.getItem(LS_KEY);
    if (!saved) {
      overlay.style.display = 'flex';
      adminRoot.style.display = 'none';
    } else {
      overlay.style.display = 'none';
      adminRoot.style.display = 'block';
    }

    $('#pw-enter')?.addEventListener('click', ()=>{
      const v = ($('#admin-pw').value||'').trim();
      if(!v){ $('#pw-err').textContent = '请输入口令'; return; }
      try{ localStorage.setItem(LS_KEY, v); }catch{}
      overlay.style.display = 'none';
      adminRoot.style.display = 'block';
    });

    $('#logout-admin')?.addEventListener('click', ()=>{
      if(!confirm('确定退出登录？')) return;
      try{ localStorage.removeItem(LS_KEY); }catch{}
      location.reload();
    });

    // ---------- 通用请求工具（自动携带 Authorization） ----------
    function authHeader(){
      try{
        const pw = localStorage.getItem(LS_KEY);
        if(!pw) return {};
        return { 'Authorization': 'Bearer ' + pw };
      }catch{ return {}; }
    }
    async function fetchJSON(url, init={}) {
      const headers = Object.assign({ }, authHeader(), init.headers||{});
      const res  = await fetch(url, { cache:'no-store', ...init, headers });
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch {}
      return { res, ok: res.ok, status: res.status, data, text };
    }
    async function getJSON(url) {
      const r = await fetchJSON(url, { method:'GET' });
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      if (!r.data) throw '响应不是 JSON';
      return r.data;
    }
    async function postJSON(url, payload) {
      const r = await fetchJSON(url, { method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload) });
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      return r.data || {};
    }
    async function del(url) {
      const r = await fetchJSON(url, { method:'DELETE' });
      if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
      return r.data || {};
    }
    function today(){ return new Date().toISOString().slice(0,10); }

    // ---------- Tabs ----------
    $$('.tab-btn').forEach(b=>{
      b.onclick=()=>{
        $$('.tab-btn').forEach(x=>x.classList.toggle('active', x===b));
        $$('.tab').forEach(t=>t.classList.remove('active'));
        $('#tab-'+b.dataset.tab).classList.add('active');
      };
    });

    // ---------- 本地草稿存取 ----------
    const LS = {
      brief: 'draft.brief.v1',
      analyses: 'draft.analyses.v1',
      news: 'draft.news.v1',
      research: 'draft.research.v1',
      rArticles: 'draft.research.articles.v1'
    };
    function saveDraft(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function loadDraft(key){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch{return{}} }
    function clearDraft(key){ localStorage.removeItem(key); }
    $('#clear-drafts')?.addEventListener('click', ()=>{
      if(!confirm('确定清空本地草稿缓存？')) return;
      Object.values(LS).forEach(clearDraft);
      alert('本地草稿已清空');
    });

    /* ===== Daily Brief ===== */
    const B = { slug: $('#b-slug'), title: $('#b-title'), bullets: $('#b-bullets'), schedule: $('#b-schedule'), symbol: $('#b-symbol'), interval: $('#b-interval'), msg: $('#b-msg') };
    const bMsg = s => B.msg.textContent = s;
    function bGet(){ return { slug:B.slug.value.trim()||today(), title:B.title.value.trim()||undefined, bullets:B.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean), schedule:B.schedule.value.split('\n').map(s=>s.trim()).filter(Boolean), chart:{ symbol:B.symbol.value.trim()||undefined, interval:B.interval.value } }; }
    function bSet(d){ B.slug.value=d.slug||''; B.title.value=d.title||''; B.bullets.value=(d.bullets||[]).join('\n'); B.schedule.value=(d.schedule||[]).join('\n'); B.symbol.value=(d.chart?.symbol)||d.symbol||''; B.interval.value=(d.chart?.interval)||'60'; }
    $$('#tab-brief input, #tab-brief textarea, #tab-brief select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.brief, bGet())));
    (function(){ const d=loadDraft(LS.brief); if(Object.keys(d).length) bSet(d); })();
    $('#b-clear').onclick = ()=>{ clearDraft(LS.brief); bSet({}); bMsg('草稿已清空'); };
    $('#b-reuse').onclick = async ()=>{
      bMsg('拉取最新一条…');
      try{
        const arr = await getJSON('/daily-brief/index.json?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return bMsg('没有历史记录');
        const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].slug : arr[0];
        const d = await getJSON(`/daily-brief/${latest}.json?_=${Date.now()}`);
        d.slug = today(); bSet(d); saveDraft(LS.brief, bGet()); bMsg('已载入最近一条，并把日期改为今天');
      }catch(e){ bMsg('拉取失败：' + (e?.message || e)); }
    };
    $('#b-publish').onclick = async ()=>{
      try{ await postJSON('/daily-brief/index.json', bGet()); bMsg('✅ 发布成功'); }
      catch(e){ bMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
    };
    $('#b-preview').onclick = ()=> window.open(`/#/daily-brief/${B.slug.value.trim()||today()}`,'_blank','noopener');
    $('#b-delete').onclick = async ()=>{
      const slug=B.slug.value.trim()||today();
      if(!confirm(`确定删除 Daily Brief: ${slug} ?`)) return;
      try{ await del(`/daily-brief/${slug}.json`); bMsg('🗑️ 已删除'); }
      catch(e){ bMsg('删除失败：' + (e?.message || e || 'Unknown')); }
    };

    /* ===== Analyses ===== */
    const A = { slug: $('#a-slug'), title: $('#a-title'), symbol: $('#a-symbol'), tf: $('#a-tf'), date: $('#a-date'), bias: $('#a-bias'), tags: $('#a-tags'), supports: $('#a-supports'), resistances: $('#a-resistances'), context: $('#a-context'), view: $('#a-view'), invalidation: $('#a-invalidation'), chartSymbol: $('#a-chart-symbol'), chartInterval: $('#a-chart-interval'), msg: $('#a-msg') };
    const aMsg = s => A.msg.textContent = s;
    function aGet(){ return { slug:A.slug.value.trim(), title:A.title.value.trim(), symbol:A.symbol.value.trim(), tf:A.tf.value.trim(), date:A.date.value.trim()||today(), bias:A.bias.value, tags:A.tags.value.split(',').map(s=>s.trim()).filter(Boolean), supports:A.supports.value.split('\n').map(s=>s.trim()).filter(Boolean), resistances:A.resistances.value.split('\n').map(s=>s.trim()).filter(Boolean), context:A.context.value.trim(), view:A.view.value.trim(), invalidation:A.invalidation.value.trim(), chart:{ symbol:A.chartSymbol.value.trim()||A.symbol.value.trim(), interval:A.chartInterval.value } }; }
    function aSet(d){ A.slug.value=d.slug||''; A.title.value=d.title||''; A.symbol.value=d.symbol||''; A.tf.value=d.tf||''; A.date.value=d.date||''; A.bias.value=d.bias||'neutral'; A.tags.value=(d.tags||[]).join(', '); A.supports.value=(d.supports||[]).join('\n'); A.resistances.value=(d.resistances||[]).join('\n'); A.context.value=d.context||''; A.view.value=d.view||''; A.invalidation.value=d.invalidation||''; A.chartSymbol.value=(d.chart?.symbol)||''; A.chartInterval.value=(d.chart?.interval)||'60'; }
    $$('#tab-analyses input, #tab-analyses textarea, #tab-analyses select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.analyses, aGet())));
    (function(){ const d=loadDraft(LS.analyses); if(Object.keys(d).length) aSet(d); })();
    $('#a-clear').onclick = ()=>{ clearDraft(LS.analyses); aSet({}); aMsg('草稿已清空'); };
    $('#a-reuse').onclick = async ()=>{
      aMsg('拉取最新一条…');
      try{
        const arr = await getJSON('/analyses/index.json?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return aMsg('没有历史记录');
        const latest = arr[0].slug || arr[0];
        const d = await getJSON(`/analyses/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
        const base=(d.symbol||'idea').toLowerCase().replace(/[^a-z0-9]+/g,''); d.slug=`${base}-${today()}`; d.date=today();
        aSet(d); saveDraft(LS.analyses, aGet()); aMsg('已载入最近一条，slug/日期已更新为今天');
      }catch{ aMsg('拉取失败'); }
    };
    $('#a-publish').onclick = async ()=>{
      const payload=aGet(); if(!payload.slug) return aMsg('请填写 slug');
      try{ await postJSON('/analyses/index.json', payload); aMsg('✅ 发布成功'); }
      catch(e){ aMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
    };
    $('#a-preview').onclick = ()=>{ const slug=A.slug.value.trim(); if(!slug) return aMsg('请先填写 slug'); window.open(`/#/trade-journal?slug=${encodeURIComponent(slug)}`,'_blank','noopener'); };
    $('#a-delete').onclick = async ()=>{
      const slug=A.slug.value.trim(); if(!slug) return aMsg('请先填写 slug');
      if(!confirm(`确定删除分析：${slug} ?`)) return;
      try{ await del(`/analyses/${encodeURIComponent(slug)}.json`); aMsg('🗑️ 已删除'); }
      catch(e){ aMsg('删除失败：' + (e?.message || e || 'Unknown')); }
    };

    /* ===== News ===== */
    const N = { id: $('#n-id'), title: $('#n-title'), source: $('#n-source'), url: $('#n-url'), date: $('#n-date'), tags: $('#n-tags'), summary: $('#n-summary'), bullets: $('#n-bullets'), msg: $('#n-msg') };
    const nMsg = s => N.msg.textContent = s;
    function nGet(){ return { id:N.id.value.trim(), title:N.title.value.trim(), source:N.source.value.trim(), url:N.url.value.trim(), date:N.date.value.trim()||new Date().toISOString(), tags:N.tags.value.split(',').map(s=>s.trim()).filter(Boolean), summary:N.summary.value.trim(), bullets:N.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean) }; }
    function nSet(d){ N.id.value=d.id||''; N.title.value=d.title||''; N.source.value=d.source||''; N.url.value=d.url||''; N.date.value=d.date||''; N.tags.value=(d.tags||[]).join(', '); N.summary.value=d.summary||''; N.bullets.value=(d.bullets||[]).join('\n'); }
    $$('#tab-news input, #tab-news textarea').forEach(el=> el.addEventListener('input', ()=> localStorage.setItem(LS.news, JSON.stringify(nGet()))));
    (function(){ try{ const d = JSON.parse(localStorage.getItem(LS.news)||'{}'); if(Object.keys(d).length) nSet(d); }catch{} })();
    $('#n-clear').onclick = ()=>{ localStorage.removeItem(LS.news); nSet({}); nMsg('草稿已清空'); };
    $('#n-reuse').onclick = async ()=>{
      nMsg('拉取最新一条…');
      try{
        const arr = await getJSON('/market-news/index.json?_=' + Date.now());
        if(!Array.isArray(arr)||!arr.length) return nMsg('没有历史记录');
        const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].id : arr[0];
        const d = await getJSON(`/market-news/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
        const base=today(); d.id=`${base}-1`; d.date=new Date().toISOString();
        nSet(d); localStorage.setItem(LS.news, JSON.stringify(nGet())); nMsg('已载入最近一条，已建议新的 id');
      }catch(e){ nMsg('拉取失败：' + (e?.message || e)); }
    };
    $('#n-publish').onclick = async ()=>{
      const payload=nGet(); if(!payload.id) return nMsg('请填写 id');
      try{ await postJSON('/market-news/index.json', payload); nMsg('✅ 发布成功'); }
      catch(e){ nMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
    };
    $('#n-preview').onclick = ()=> window.open('/#/market-news','_blank','noopener');
    $('#n-delete').onclick = async ()=>{
      const id=N.id.value.trim(); if(!id) return nMsg('请先填写 id');
      if(!confirm(`确定删除快讯：${id} ?`)) return;
      try{ await del(`/market-news/${encodeURIComponent(id)}.json`); nMsg('🗑️ 已删除'); }
      catch(e){ nMsg('删除失败：' + (e?.message || e || 'Unknown')); }
    };

    /* ===== Research (syllabus) ===== */
    const R = { json: $('#r-json'), msg: $('#r-msg') };
    function rMsg(s){ R.msg.textContent = s; }
    function rGet(){ let syllabus; try{ syllabus = JSON.parse(R.json.value); }catch{ syllabus = null; } return syllabus; }
    $$('#tab-research textarea').forEach(el=> el.addEventListener('input', ()=> localStorage.setItem(LS.research, JSON.stringify({text: R.json.value}))));
    (function(){ try{ const d = JSON.parse(localStorage.getItem(LS.research)||'{}'); if (d && typeof d.text==='string') R.json.value = d.text; }catch{} })();
    $('#r-load').onclick = async ()=>{
      rMsg('加载线上大纲…');
      try{
        const j = await getJSON('/research/syllabus.json?_=' + Date.now());
        R.json.value = JSON.stringify(j.syllabus||[], null, 2);
        localStorage.setItem(LS.research, JSON.stringify({text: R.json.value})); rMsg('已载入线上版本到编辑框');
      }catch(e){ rMsg('加载失败：' + (e?.message || e)); }
    };
    $('#r-save').onclick = async ()=>{
      const syllabus = rGet(); if (!Array.isArray(syllabus)) return rMsg('JSON 格式错误，必须是数组');
      try{ await postJSON('/research/syllabus.json', { syllabus }); rMsg('✅ 保存成功'); }
      catch(e){ rMsg('❌ 保存失败：' + (e?.message || e || 'Unknown')); }
    };
    $('#r-clear').onclick = ()=>{ localStorage.removeItem(LS.research); R.json.value=''; rMsg('草稿已清空'); };
    $('#r-preview').onclick = ()=> window.open('/#/knowledge-lab','_blank','noopener');

    /* ===== Research Articles ===== */
    const RA = { slug: $('#ra-slug'), title: $('#ra-title'), excerpt: $('#ra-excerpt'), tags: $('#ra-tags'), hero: $('#ra-hero'), body: $('#ra-body'), msg: $('#ra-msg') };
    const raMsg = s => RA.msg.textContent = s;
    const raGet = () => ({ slug:(RA.slug.value||'').trim(), title:(RA.title.value||'').trim(), excerpt:(RA.excerpt.value||'').trim(), tags:(RA.tags.value||'').split(',').map(s=>s.trim()).filter(Boolean), hero:(RA.hero.value||'').trim(), date:new Date().toISOString(), body: RA.body.value || '' });
    const raSet = d => { RA.slug.value=d.slug||''; RA.title.value=d.title||''; RA.excerpt.value=d.excerpt||''; RA.tags.value=(d.tags||[]).join(', '); RA.hero.value=d.hero||''; RA.body.value=d.body||''; };
    $$('#tab-r-articles input, #tab-r-articles textarea').forEach(el=> el.addEventListener('input', ()=> localStorage.setItem(LS.rArticles, JSON.stringify(raGet()))));
    (function(){ try{ const d = JSON.parse(localStorage.getItem(LS.rArticles)||'{}'); if(Object.keys(d).length) raSet(d); }catch{} })();
    $('#ra-clear').onclick = ()=>{ localStorage.removeItem(LS.rArticles); raSet({}); raMsg('草稿已清空'); };
    $('#ra-reuse').onclick = async ()=>{
      raMsg('拉取最新一篇…');
      try{
        const list = await getJSON('/research/articles/index.json?_=' + Date.now());
        if(!Array.isArray(list)||!list.length) return raMsg('没有历史记录');
        const latestSlug = list[0].slug || list[0];
        const d = await getJSON(`/research/articles/${encodeURIComponent(latestSlug)}.json?_=${Date.now()}`);
        const base=(d.slug||'article').replace(/[^a-z0-9\-]+/gi,''); d.slug=base+'-'+today(); d.date=new Date().toISOString();
        raSet(d); localStorage.setItem(LS.rArticles, JSON.stringify(raGet())); raMsg('已载入最近一篇，已建议新的 slug');
      }catch(e){ raMsg('拉取失败：' + (e?.message || e)); }
    };
    $('#ra-publish').onclick = async ()=>{
      const payload=raGet(); if(!payload.slug) return raMsg('请填写 slug');
      try{ await postJSON('/research/articles/index.json', payload); raMsg('✅ 发布成功'); }
      catch(e){ raMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
    };
    $('#ra-preview').onclick = ()=>{
      const slug=(RA.slug.value||'').trim(); if(!slug) return raMsg('请先填写 slug');
      window.open(`/research/articles/${encodeURIComponent(slug)}.json`, '_blank', 'noopener');
    };
    $('#ra-delete').onclick = async ()=>{
      const slug=RA.slug.value.trim(); if(!slug) return raMsg('请先填写 slug');
      if(!confirm(`确定删除文章：${slug} ?`)) return;
      try{ await del(`/research/articles/${encodeURIComponent(slug)}.json`); raMsg('🗑️ 已删除');
      }catch(e){ raMsg('删除失败：' + (e?.message || e || 'Unknown')); }
    };

    // ---------- 快捷键：当前标签执行发布 ----------
    document.addEventListener('keydown', e=>{
      if(!(e.key==='Enter'&&(e.ctrlKey||e.metaKey))) return;
      if($('#tab-brief').classList.contains('active')) return $('#b-publish').click();
      if($('#tab-analyses').classList.contains('active')) return $('#a-publish').click();
      if($('#tab-news').classList.contains('active')) return $('#n-publish').click();
      if($('#tab-research').classList.contains('active')) return $('#r-save').click();
      if($('#tab-r-articles').classList.contains('active')) return $('#ra-publish').click();
    });
  </script>
</body>
</html>
