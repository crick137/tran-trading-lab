<script type="module">
  const $  = (s, el=document)=> el.querySelector(s);
  const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

  /* ========== 统一 Fetch（自动带 Cookie） ========== */
  async function apiFetch(url, init = {}) {
    // 一律走绝对路径 + 携带会话 Cookie
    const res  = await fetch(url, { credentials: 'include', cache: 'no-store', ...init });
    const text = await res.text();
    let data = null; try { data = JSON.parse(text); } catch {}
    return { res, ok: res.ok, status: res.status, data, text };
  }
  async function fetchJSON(url, init={}) {
    return apiFetch(url, init);
  }
  async function getJSON(url) {
    const r = await apiFetch(url);
    if (!r.ok) throw (r.data?.error || r.text || `HTTP ${r.status}`);
    if (!r.data) throw '响应不是 JSON';
    return r.data;
  }
  const today = ()=> new Date().toISOString().slice(0,10);

  /* ========== 登录门禁：真正走 /api/admin/login /verify /logout ========== */
  const overlay  = $('#pw-overlay');
  const adminRoot= $('#admin-root');

  async function syncLoginUI() {
    try {
      const j = await getJSON('/api/admin/verify?_=' + Date.now());
      const authed = !!j.authed;
      overlay.style.display   = authed ? 'none'  : 'flex';
      adminRoot.style.display = authed ? 'block' : 'none';
      return authed;
    } catch {
      overlay.style.display   = 'flex';
      adminRoot.style.display = 'none';
      return false;
    }
  }

  $('#pw-enter')?.addEventListener('click', async ()=>{
    const pw = ($('#admin-pw').value||'').trim();
    if (!pw) { $('#pw-err').textContent = '请输入口令'; return; }
    $('#pw-err').textContent = '登录中…';
    try {
      const { res, data, text } = await apiFetch('/api/admin/login', {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify({ password: pw })
      });
      if (!res.ok || !data?.ok) throw new Error(data?.error || text || `HTTP ${res.status}`);
      await syncLoginUI();
      $('#pw-err').textContent = '';
      $('#admin-pw').value = '';
    } catch(e) {
      $('#pw-err').textContent = '登录失败：' + (e?.message || e);
    }
  });

  $('#logout-admin')?.addEventListener('click', async ()=>{
    if (!confirm('确定退出登录？')) return;
    try { await apiFetch('/api/admin/logout', { method:'POST' }); } catch {}
    location.reload();
  });

  // 首次进入时做一次验证，决定显示遮罩还是后台主体
  await syncLoginUI();

  /* ========== 移除任何旧的口令条 DOM（保险丝） ========== */
  (function removeLegacyPwBar(){
    const selectors = [
      '.pw-group', '.topbar .pw', '.topbar .remember', '.topbar .clear',
      '#publish-pw', 'input[name="publishPassword"]', 'label[for="publish-pw"]',
      '.publish-password'
    ];
    selectors.forEach(sel=> document.querySelectorAll(sel).forEach(el=> el.remove()));
    document.querySelectorAll('.topbar').forEach(tb=>{
      if(!tb.textContent.trim() || tb.children.length === 0) tb.remove();
    });
  })();

  /* ========== Tabs ========== */
  $$('.tab-btn').forEach(b=>{
    b.onclick=()=>{
      $$('.tab-btn').forEach(x=>x.classList.toggle('active', x===b));
      $$('.tab').forEach(t=>t.classList.remove('active'));
      $('#tab-'+b.dataset.tab).classList.add('active');
    };
  });

  /* ========== 草稿工具 ========== */
  const LS = {
    brief:'draft.brief.v1', analyses:'draft.analyses.v1',
    news:'draft.news.v1',   research:'draft.research.v1',
    rArticles:'draft.research.articles.v1'
  };
  const saveDraft =(k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const loadDraft = k => { try{return JSON.parse(localStorage.getItem(k)||'{}')}catch{return{}} };
  const clearDraft= k => localStorage.removeItem(k);
  $('#clear-drafts')?.addEventListener('click', ()=>{
    if(!confirm('确定清空本地草稿缓存？')) return;
    Object.values(LS).forEach(clearDraft);
    alert('本地草稿已清空');
  });

  /* ========== Daily Brief ========== */
  const B = { slug:$('#b-slug'), title:$('#b-title'), bullets:$('#b-bullets'), schedule:$('#b-schedule'),
              symbol:$('#b-symbol'), interval:$('#b-interval'), msg:$('#b-msg') };
  const bMsg = s => B.msg.textContent = s;
  const bGet = ()=>({
    slug:B.slug.value.trim()||today(),
    title:B.title.value.trim()||undefined,
    bullets:B.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean),
    schedule:B.schedule.value.split('\n').map(s=>s.trim()).filter(Boolean),
    chart:{ symbol:B.symbol.value.trim()||undefined, interval:B.interval.value }
  });
  function bSet(d){ B.slug.value=d.slug||''; B.title.value=d.title||''; B.bullets.value=(d.bullets||[]).join('\n'); B.schedule.value=(d.schedule||[]).join('\n'); B.symbol.value=(d.chart?.symbol)||d.symbol||''; B.interval.value=(d.chart?.interval)||'60'; }
  $$('#tab-brief input, #tab-brief textarea, #tab-brief select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.brief, bGet())));
  (function(){ const d=loadDraft(LS.brief); if(Object.keys(d).length) bSet(d); })();
  $('#b-clear').onclick = ()=>{ clearDraft(LS.brief); bSet({}); bMsg('草稿已清空'); };

  $('#b-reuse').onclick = async ()=>{
    bMsg('拉取最新一条…');
    try{
      const arr = await getJSON('/api/daily-brief/index?_=' + Date.now());
      if(!Array.isArray(arr)||!arr.length) return bMsg('没有历史记录');
      const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].slug : arr[0];
      const d = await getJSON(`/api/daily-brief/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
      d.slug = today(); bSet(d); saveDraft(LS.brief, bGet()); bMsg('已载入最近一条，并把日期改为今天');
    }catch(e){ bMsg('拉取失败：' + (e?.message || e)); }
  };

  $('#b-publish').onclick = async ()=>{
    const payload = bGet();
    const slug = payload.slug || today();
    bMsg('发布中…');
    try{
      const { res, data } = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, {
        method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      bMsg('✅ 发布成功');
    }catch(e){ bMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
  };
  $('#b-preview').onclick = ()=> window.open(`/#/daily-brief/${B.slug.value.trim()||today()}`,'_blank','noopener');
  $('#b-delete').onclick = async ()=>{
    const slug=B.slug.value.trim()||today();
    if(!confirm(`确定删除 Daily Brief: ${slug} ?`)) return;
    bMsg('删除中…');
    try{
      const { res, data } = await fetchJSON(`/api/daily-brief/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      bMsg('🗑️ 已删除');
    }catch(e){ bMsg('删除失败：' + (e?.message || e || 'Unknown')); }
  };

  /* ========== Analyses ========== */
  const A = { slug:$('#a-slug'), title:$('#a-title'), symbol:$('#a-symbol'), tf:$('#a-tf'), date:$('#a-date'),
              bias:$('#a-bias'), tags:$('#a-tags'), supports:$('#a-supports'), resistances:$('#a-resistances'),
              context:$('#a-context'), view:$('#a-view'), invalidation:$('#a-invalidation'),
              chartSymbol:$('#a-chart-symbol'), chartInterval:$('#a-chart-interval'), msg:$('#a-msg') };
  const aMsg = s => A.msg.textContent = s;
  const aGet = ()=>({
    slug:A.slug.value.trim(), title:A.title.value.trim(), symbol:A.symbol.value.trim(),
    tf:A.tf.value.trim(), date:A.date.value.trim()||today(), bias:A.bias.value,
    tags:A.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
    supports:A.supports.value.split('\n').map(s=>s.trim()).filter(Boolean),
    resistances:A.resistances.value.split('\n').map(s=>s.trim()).filter(Boolean),
    context:A.context.value.trim(), view:A.view.value.trim(), invalidation:A.invalidation.value.trim(),
    chart:{ symbol:A.chartSymbol.value.trim()||A.symbol.value.trim(), interval:A.chartInterval.value }
  });
  function aSet(d){ A.slug.value=d.slug||''; A.title.value=d.title||''; A.symbol.value=d.symbol||''; A.tf.value=d.tf||''; A.date.value=d.date||''; A.bias.value=d.bias||'neutral'; A.tags.value=(d.tags||[]).join(', '); A.supports.value=(d.supports||[]).join('\n'); A.resistances.value=(d.resistances||[]).join('\n'); A.context.value=d.context||''; A.view.value=d.view||''; A.invalidation.value=d.invalidation||''; A.chartSymbol.value=(d.chart?.symbol)||''; A.chartInterval.value=(d.chart?.interval)||'60'; }
  $$('#tab-analyses input, #tab-analyses textarea, #tab-analyses select').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.analyses, aGet())));
  (function(){ const d=loadDraft(LS.analyses); if(Object.keys(d).length) aSet(d); })();
  $('#a-clear').onclick = ()=>{ clearDraft(LS.analyses); aSet({}); aMsg('草稿已清空'); };

  $('#a-reuse').onclick = async ()=>{
    aMsg('拉取最新一条…');
    try{
      const arr = await getJSON('/api/analyses/index?_=' + Date.now());
      if(!Array.isArray(arr)||!arr.length) return aMsg('没有历史记录');
      const latest = arr[0].slug || arr[0];
      const d = await getJSON(`/api/analyses/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
      const base=(d.symbol||'idea').toLowerCase().replace(/[^a-z0-9]+/g,'');
      d.slug=`${base}-${today()}`; d.date=today();
      aSet(d); saveDraft(LS.analyses, aGet());
      aMsg('已载入最近一条，slug/日期已更新为今天');
    }catch{ aMsg('拉取失败'); }
  };

  $('#a-publish').onclick = async ()=>{
    const payload=aGet(); if(!payload.slug) return aMsg('请填写 slug');
    aMsg('发布中…');
    try{
      const { res, data } = await fetchJSON(`/api/analyses/${encodeURIComponent(payload.slug)}.json`, {
        method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      aMsg('✅ 发布成功');
    }catch(e){ aMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
  };
  $('#a-preview').onclick = ()=>{ const slug=A.slug.value.trim(); if(!slug) return aMsg('请先填写 slug'); window.open(`/#/trade-journal?slug=${encodeURIComponent(slug)}`,'_blank','noopener'); };
  $('#a-delete').onclick = async ()=>{
    const slug=A.slug.value.trim(); if(!slug) return aMsg('请先填写 slug');
    if(!confirm(`确定删除分析：${slug} ?`)) return;
    aMsg('删除中…');
    try{
      const { res, data } = await fetchJSON(`/api/analyses/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      aMsg('🗑️ 已删除');
    }catch(e){ aMsg('删除失败：' + (e?.message || e || 'Unknown')); }
  };

  /* ========== Market News ========== */
  const N = { id:$('#n-id'), title:$('#n-title'), source:$('#n-source'), url:$('#n-url'),
              date:$('#n-date'), tags:$('#n-tags'), summary:$('#n-summary'), bullets:$('#n-bullets'), msg:$('#n-msg') };
  const nMsg = s => N.msg.textContent = s;
  const nGet = ()=>({
    id:N.id.value.trim(), title:N.title.value.trim(), source:N.source.value.trim(),
    url:N.url.value.trim(), date:N.date.value.trim()||new Date().toISOString(),
    tags:N.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
    summary:N.summary.value.trim(),
    bullets:N.bullets.value.split('\n').map(s=>s.trim()).filter(Boolean)
  });
  function nSet(d){ N.id.value=d.id||''; N.title.value=d.title||''; N.source.value=d.source||''; N.url.value=d.url||''; N.date.value=d.date||''; N.tags.value=(d.tags||[]).join(', '); N.summary.value=d.summary||''; N.bullets.value=(d.bullets||[]).join('\n'); }
  $$('#tab-news input, #tab-news textarea').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.news, nGet())));
  (function(){ const d=loadDraft(LS.news); if(Object.keys(d).length) nSet(d); })();
  $('#n-clear').onclick = ()=>{ clearDraft(LS.news); nSet({}); nMsg('草稿已清空'); };

  $('#n-reuse').onclick = async ()=>{
    nMsg('拉取最新一条…');
    try{
      const arr = await getJSON('/api/market-news/index?_=' + Date.now());
      if(!Array.isArray(arr)||!arr.length) return nMsg('没有历史记录');
      const latest = (arr[0] && typeof arr[0]==='object') ? arr[0].id : arr[0];
      const d = await getJSON(`/api/market-news/${encodeURIComponent(latest)}.json?_=${Date.now()}`);
      const base = new Date().toISOString().slice(0,10);
      d.id = `${base}-1`; d.date = new Date().toISOString();
      nSet(d); saveDraft(LS.news, nGet());
      nMsg('已载入最近一条，已建议新的 id');
    }catch(e){ nMsg('拉取失败：' + (e?.message || e)); }
  };

  $('#n-publish').onclick = async ()=>{
    const payload = nGet(); if(!payload.id) return nMsg('请填写 id');
    nMsg('发布中…');
    try{
      const { res, data } = await fetchJSON(`/api/market-news/${encodeURIComponent(payload.id)}.json`, {
        method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      nMsg('✅ 发布成功');
    }catch(e){ nMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
  };
  $('#n-preview').onclick = ()=> window.open('/#/market-news','_blank','noopener');
  $('#n-delete').onclick = async ()=>{
    const id=N.id.value.trim(); if(!id) return nMsg('请先填写 id');
    if(!confirm(`确定删除快讯：${id} ?`)) return;
    nMsg('删除中…');
    try{
      const { res, data } = await fetchJSON(`/api/market-news/${encodeURIComponent(id)}.json`, { method:'DELETE' });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      nMsg('🗑️ 已删除');
    }catch(e){ nMsg('删除失败：' + (e?.message || e || 'Unknown')); }
  };

  /* ========== Research（Syllabus） ========== */
  const R = { json:$('#r-json'), msg:$('#r-msg') };
  const rMsg = s => R.msg.textContent = s;
  const rGet = ()=>{ try{ return JSON.parse(R.json.value) }catch{ return null } };
  $$('#tab-research textarea').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.research, {text:R.json.value})));
  (function(){ const d=loadDraft(LS.research); if(d && typeof d.text==='string') R.json.value=d.text; })();
  $('#r-load').onclick = async ()=>{
    rMsg('加载线上大纲…');
    try{
      const j = await getJSON('/api/research/syllabus?_=' + Date.now());
      R.json.value = JSON.stringify(j.syllabus||[], null, 2);
      saveDraft(LS.research, {text:R.json.value});
      rMsg('已载入线上版本到编辑框');
    }catch(e){ rMsg('加载失败：' + (e?.message || e)); }
  };
  $('#r-save').onclick = async ()=>{
    const syllabus = rGet(); if (!Array.isArray(syllabus)) return rMsg('JSON 格式错误，必须是数组');
    rMsg('保存中…');
    try{
      const { res, data } = await fetchJSON('/api/research/syllabus', {
        method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ syllabus })
      });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      rMsg('✅ 保存成功');
    }catch(e){ rMsg('❌ 保存失败：' + (e?.message || e || 'Unknown')); }
  };
  $('#r-clear').onclick = ()=>{ localStorage.removeItem(LS.research); R.json.value=''; rMsg('草稿已清空'); };
  $('#r-preview').onclick = ()=> window.open('/#/knowledge-lab','_blank','noopener');

  /* ========== Research Articles ========== */
  const RA = { slug:$('#ra-slug'), title:$('#ra-title'), excerpt:$('#ra-excerpt'),
               tags:$('#ra-tags'), hero:$('#ra-hero'), body:$('#ra-body'), msg:$('#ra-msg') };
  const raMsg = s => RA.msg.textContent = s;
  const raGet = ()=>({
    slug:(RA.slug.value||'').trim(), title:(RA.title.value||'').trim(), excerpt:(RA.excerpt.value||'').trim(),
    tags:(RA.tags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    hero:(RA.hero.value||'').trim(), date:new Date().toISOString(), body: RA.body.value || ''
  });
  const raSet = d => { RA.slug.value=d.slug||''; RA.title.value=d.title||''; RA.excerpt.value=d.excerpt||''; RA.tags.value=(d.tags||[]).join(', '); RA.hero.value=d.hero||''; RA.body.value=d.body||''; };
  $$('#tab-r-articles input, #tab-r-articles textarea').forEach(el=> el.addEventListener('input', ()=> saveDraft(LS.rArticles, raGet())));
  (function(){ const d=loadDraft(LS.rArticles); if(Object.keys(d).length) raSet(d); })();
  $('#ra-clear').onclick = ()=>{ localStorage.removeItem(LS.rArticles); raSet({}); raMsg('草稿已清空'); };

  $('#ra-reuse').onclick = async ()=>{
    raMsg('拉取最新一篇…');
    try{
      const list = await getJSON('/api/research/articles/index?_=' + Date.now());
      if(!Array.isArray(list)||!list.length) return raMsg('没有历史记录');
      const latestSlug = list[0].slug || list[0];
      const d = await getJSON(`/api/research/articles/${encodeURIComponent(latestSlug)}.json?_=${Date.now()}`);
      const base=(d.slug||'article').replace(/[^a-z0-9\-]+/gi,'');
      d.slug=base+'-'+today(); d.date=new Date().toISOString();
      raSet(d); saveDraft(LS.rArticles, raGet()); raMsg('已载入最近一篇，已建议新的 slug');
    }catch(e){ raMsg('拉取失败：' + (e?.message || e)); }
  };

  $('#ra-publish').onclick = async ()=>{
    const payload=raGet(); if(!payload.slug) return raMsg('请填写 slug');
    raMsg('发布中…');
    try{
      const { res, data } = await fetchJSON(`/api/research/articles/${encodeURIComponent(payload.slug)}.json`, {
        method:'PUT', headers:{ 'content-type':'application/json' }, body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      raMsg('✅ 发布成功');
    }catch(e){ raMsg('❌ 发布失败：' + (e?.message || e || 'Unknown')); }
  };

  $('#ra-preview').onclick = ()=>{
    const slug=(RA.slug.value||'').trim(); if(!slug) return raMsg('请先填写 slug');
    window.open(`/api/research/articles/${encodeURIComponent(slug)}.json`, '_blank', 'noopener');
  };

  $('#ra-delete').onclick = async ()=>{
    const slug=RA.slug.value.trim(); if(!slug) return raMsg('请先填写 slug');
    if(!confirm(`确定删除文章：${slug} ?`)) return;
    raMsg('删除中…');
    try{
      const { res, data } = await fetchJSON(`/api/research/articles/${encodeURIComponent(slug)}.json`, { method:'DELETE' });
      if(!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
      raMsg('🗑️ 已删除');
    }catch(e){ raMsg('删除失败：' + (e?.message || e || 'Unknown')); }
  };

  /* ========== 快捷键：Ctrl/Cmd + Enter ========== */
  document.addEventListener('keydown', e=>{
    if(!(e.key==='Enter'&&(e.ctrlKey||e.metaKey))) return;
    if($('#tab-brief').classList.contains('active')) return $('#b-publish').click();
    if($('#tab-analyses').classList.contains('active')) return $('#a-publish').click();
    if($('#tab-news').classList.contains('active')) return $('#n-publish').click();
    if($('#tab-research').classList.contains('active')) return $('#r-save').click();
    if($('#tab-r-articles').classList.contains('active')) return $('#ra-publish').click();
  });
</script>
